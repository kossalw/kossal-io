#!/bin/bash

set -e

export $(cat .env | sed 's/#.*//g' | xargs)

CREATE_MB_ADMIN_USER_QUERY="CREATE ROLE $METABASE_DB_USER WITH LOGIN PASSWORD '$METABASE_DB_PASSWORD';"
CREATE_MB_DB_QUERY="CREATE DATABASE $METABASE_DB_DATABASE WITH OWNER = $METABASE_DB_USER ENCODING = 'UTF8' LC_COLLATE = 'en_US.utf8' LC_CTYPE = 'en_US.utf8' TEMPLATE = template0;"

CREATE_MB_READER_USER_QUERY=$(cat << EOF
CREATE ROLE $METABASE_DB_READER_USER WITH LOGIN PASSWORD '$METABASE_DB_READER_PASSWORD';

GRANT CONNECT ON DATABASE app TO metabase;

GRANT USAGE ON SCHEMA public, misc, company, bookings TO metabase;

GRANT SELECT ON ALL TABLES IN SCHEMA public, misc, company, bookings TO metabase;

GRANT SELECT ON ALL SEQUENCES IN SCHEMA public, misc, company, bookings TO metabase;

ALTER DEFAULT PRIVILEGES IN SCHEMA public, misc, company, bookings
GRANT SELECT ON TABLES TO metabase;

ALTER DEFAULT PRIVILEGES IN SCHEMA public, misc, company, bookings
GRANT SELECT ON SEQUENCES TO metabase;
EOF
)

psql -h $PG_HOST -p $PG_PORT -U $PG_USER -W -d $PG_DB -c "$CREATE_MB_ADMIN_USER_QUERY"
psql -h $PG_HOST -p $PG_PORT -U $PG_USER -W -d $PG_DB -c "$CREATE_MB_DB_QUERY"
psql -h $PG_HOST -p $PG_PORT -U $PG_USER -W -d $PG_DB -c "$CREATE_MB_READER_USER_QUERY"